<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hata Chat | Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-main: #0c1317;
            --bg-side: #111b21;
            --panel: #202c33;
            --accent: #00a884;
            --border: #222d34;
            --text: #e9edef;
        }
        body { background-color: var(--bg-main); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }
        .chat-pattern { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.04; pointer-events: none; }
        .glass { background: rgba(32, 44, 51, 0.95); backdrop-filter: blur(10px); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .msg-shadow { box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .avatar-selected { border: 3px solid var(--accent); transform: scale(1.05); }
    </style>
</head>
<body class="h-screen flex">

    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-[#0c1317] flex items-center justify-center p-6">
        <div class="bg-[#111b21] p-10 rounded-2xl shadow-2xl w-full max-w-lg border border-[#222d34]">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-[#00a884] rounded-3xl rotate-12 flex items-center justify-center mx-auto mb-6 shadow-xl shadow-emerald-900/20">
                    <i class="fa-solid fa-paper-plane text-white text-3xl -rotate-12"></i>
                </div>
                <h1 class="text-3xl font-bold tracking-tight">Welcome to Hata</h1>
                <p class="text-gray-400 mt-2">Connect instantly with a phone & username</p>
            </div>

            <div class="space-y-5">
                <input id="reg-phone" type="text" placeholder="Phone Number" class="w-full p-4 rounded-xl bg-[#202c33] border border-[#2d3a43] focus:border-[#00a884] outline-none transition">
                <input id="reg-username" type="text" placeholder="Username" class="w-full p-4 rounded-xl bg-[#202c33] border border-[#2d3a43] focus:border-[#00a884] outline-none transition">
                
                <p class="text-xs font-bold text-gray-500 uppercase">Select Professional Avatar</p>
                <div id="avatar-grid" class="grid grid-cols-5 gap-3 p-2">
                    </div>

                <button onclick="handleRegister()" id="login-btn" class="w-full bg-[#00a884] hover:bg-[#06cf9c] text-white py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-emerald-900/20">
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <nav class="w-16 h-screen bg-[#202c33] flex flex-col items-center py-6 space-y-8 border-r border-[#2d3a43] shrink-0 hidden md:flex">
        <img id="my-avatar" src="1avatar.png" class="w-10 h-10 rounded-full border border-gray-600 object-cover cursor-pointer">
        <div class="flex flex-col space-y-6 text-gray-400 text-xl">
            <i class="fa-solid fa-message text-white"></i>
            <i class="fa-solid fa-circle-notch hover:text-white cursor-pointer"></i>
            <i class="fa-solid fa-users hover:text-white cursor-pointer"></i>
            <i class="fa-solid fa-gear hover:text-white cursor-pointer mt-auto"></i>
        </div>
    </nav>

    <div class="w-full md:w-[400px] bg-[#111b21] flex flex-col border-r border-[#222d34]">
        <header class="p-4 flex justify-between items-center glass shrink-0">
            <h2 class="text-xl font-bold">Chats</h2>
            <button onclick="promptAddContact()" class="w-10 h-10 bg-[#2a3942] rounded-full flex items-center justify-center hover:bg-[#374151] transition">
                <i class="fa-solid fa-plus text-sm"></i>
            </button>
        </header>

        <div class="p-3">
            <div class="bg-[#202c33] flex items-center px-4 py-2 rounded-xl border border-transparent focus-within:border-[#00a884]/50 transition">
                <i class="fa-solid fa-magnifying-glass text-gray-500 text-sm"></i>
                <input type="text" placeholder="Search contacts..." class="bg-transparent border-none w-full p-1 text-sm outline-none ml-3 text-white">
            </div>
        </div>

        <div id="chat-list" class="flex-1 overflow-y-auto custom-scroll">
            </div>
    </div>

    <main id="chat-window" class="hidden flex-1 flex-col bg-[#0b141a] relative">
        <div class="chat-pattern absolute inset-0"></div>
        
        <header class="h-16 flex items-center justify-between px-6 bg-[#202c33]/90 backdrop-blur-md z-10 border-b border-[#2d3a43]">
            <div class="flex items-center">
                <img id="active-avatar" src="1avatar.png" class="w-10 h-10 rounded-full object-cover mr-4">
                <div>
                    <h3 id="active-name" class="font-bold text-sm">...</h3>
                    <p class="text-[11px] text-[#00a884] font-medium uppercase tracking-wider">online</p>
                </div>
            </div>
            <div class="flex space-x-6 text-gray-400">
                <i class="fa-solid fa-video hover:text-white cursor-pointer"></i>
                <i class="fa-solid fa-phone hover:text-white cursor-pointer"></i>
                <i class="fa-solid fa-ellipsis-vertical hover:text-white cursor-pointer"></i>
            </div>
        </header>

        <div id="messages-container" class="flex-1 overflow-y-auto p-6 md:px-24 flex flex-col space-y-3 z-10 custom-scroll">
            </div>

        <footer class="p-4 bg-[#202c33] z-10 flex items-center space-x-4">
            <div class="flex space-x-4 text-gray-400 px-2">
                <i class="fa-regular fa-face-smile text-2xl cursor-pointer hover:text-white"></i>
                <i class="fa-solid fa-paperclip text-2xl cursor-pointer hover:text-white"></i>
            </div>
            <input id="msg-input" type="text" placeholder="Write a message..." class="flex-1 bg-[#2a3942] rounded-xl py-3 px-5 outline-none text-sm text-white border border-transparent focus:border-[#00a884]/30 transition">
            <button onclick="handleSend()" class="w-12 h-12 bg-[#00a884] text-white rounded-xl hover:bg-[#06cf9c] flex items-center justify-center transition shadow-lg shadow-emerald-900/20">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </footer>
    </main>

    <div id="empty-state" class="flex flex-1 flex-col items-center justify-center bg-[#222d34] text-center p-10">
        <div class="w-32 h-32 bg-[#2a3942] rounded-full flex items-center justify-center mb-8">
            <i class="fa-solid fa-comments text-[#00a884] text-5xl"></i>
        </div>
        <h2 class="text-3xl font-bold mb-4">Hata Web</h2>
        <p class="text-gray-400 max-w-sm leading-relaxed">Select a chat to start messaging. All your conversations are synced in real-time across your devices.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG INTEGRATED
        const firebaseConfig = {
            apiKey: "AIzaSyDvGxOjelljEImC8pKK1JzBKTGhdH65Ak8",
            authDomain: "hata-cf1b3.firebaseapp.com",
            projectId: "hata-cf1b3",
            storageBucket: "hata-cf1b3.firebasestorage.app",
            messagingSenderId: "119706055200",
            appId: "1:119706055200:web:254903ed589fec94954245",
            measurementId: "G-4EHZD5YEK5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let activeChatId = null;
        let selectedAvatar = '1avatar.png';

        // SETUP AVATARS
        const grid = document.getElementById('avatar-grid');
        for(let i=1; i<=10; i++) {
            const container = document.createElement('div');
            const img = document.createElement('img');
            const path = `${i}avatar.png`;
            img.src = path;
            img.className = "w-full aspect-square rounded-xl cursor-pointer border-2 border-transparent object-cover transition hover:bg-[#2a3942]";
            img.onerror = () => img.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${i}`; // Fallback if local file missing
            
            img.onclick = () => {
                document.querySelectorAll('#avatar-grid img').forEach(el => el.classList.remove('avatar-selected'));
                img.classList.add('avatar-selected');
                selectedAvatar = path;
            };
            container.appendChild(img);
            grid.appendChild(container);
            if(i === 1) img.click(); // Default select first
        }

        window.handleRegister = async () => {
            const phone = document.getElementById('reg-phone').value.trim();
            const username = document.getElementById('reg-username').value.trim();
            if(!phone || !username) return alert("Fill in your details!");

            const userId = `${phone}_${username.toLowerCase()}`;
            const userRef = doc(db, "users", userId);

            try {
                const snap = await getDoc(userRef);
                if(snap.exists()) {
                    currentUser = { id: userId, ...snap.data() };
                } else {
                    currentUser = { id: userId, username, phone, avatar: selectedAvatar, contacts: [], joinedAt: serverTimestamp() };
                    await setDoc(userRef, currentUser);
                }
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('my-avatar').src = currentUser.avatar;
                loadChatList();
            } catch (e) { alert("Check Firebase Rules!"); }
        };

        window.promptAddContact = async () => {
            const phone = prompt("Enter Friend's Phone:");
            const name = prompt("Enter Friend's Username:");
            if(!phone || !name) return;

            const targetId = `${phone}_${name.toLowerCase()}`;
            const targetSnap = await getDoc(doc(db, "users", targetId));

            if(!targetSnap.exists()) return alert("User not found!");

            const chatId = [currentUser.id, targetId].sort().join("_");
            await setDoc(doc(db, "chats", chatId), {
                participantIds: [currentUser.id, targetId],
                participants: [currentUser.username, name],
                participantAvatars: [currentUser.avatar, targetSnap.data().avatar],
                lastMessage: "New chat started",
                lastTimestamp: serverTimestamp()
            }, { merge: true });

            openChat(chatId, name, targetSnap.data().avatar);
        };

        function loadChatList() {
            const q = query(collection(db, "chats"), where("participantIds", "array-contains", currentUser.id));
            onSnapshot(q, (snap) => {
                const listEl = document.getElementById('chat-list');
                listEl.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const otherIdx = data.participantIds.indexOf(currentUser.id) === 0 ? 1 : 0;
                    const name = data.participants[otherIdx];
                    const avatar = data.participantAvatars[otherIdx];

                    const item = document.createElement('div');
                    item.className = `flex items-center p-4 cursor-pointer border-b border-[#222d34] hover:bg-[#202c33] transition ${activeChatId === d.id ? 'bg-[#2a3942]' : ''}`;
                    item.onclick = () => openChat(d.id, name, avatar);
                    item.innerHTML = `
                        <img src="${avatar}" class="w-14 h-14 rounded-2xl object-cover mr-4 border border-[#2d3a43]">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-bold text-white truncate">${name}</span>
                                <span class="text-[10px] text-gray-500 font-bold uppercase">Now</span>
                            </div>
                            <p class="text-xs text-gray-400 truncate">${data.lastMessage}</p>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            });
        }

        window.openChat = (chatId, name, avatar) => {
            activeChatId = chatId;
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('chat-window').style.display = 'flex';
            document.getElementById('active-name').innerText = name;
            document.getElementById('active-avatar').src = avatar;

            const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = "";
                snap.forEach(mDoc => {
                    const m = mDoc.data();
                    const isMe = m.sender === currentUser.username;
                    const msg = document.createElement('div');
                    msg.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-in fade-in duration-300`;
                    msg.innerHTML = `
                        <div class="${isMe ? 'bg-[#005c4b] rounded-tr-none' : 'bg-[#202c33] rounded-tl-none'} p-3 rounded-2xl max-w-[80%] msg-shadow relative group">
                            <p class="text-[14px] leading-relaxed mb-1">${m.content}</p>
                            <div class="flex items-center justify-end space-x-1">
                                <span class="text-[9px] text-gray-400 opacity-60">${m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                                ${isMe ? '<i class="fa-solid fa-check-double text-[9px] text-emerald-400"></i>' : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(msg);
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.handleSend = async () => {
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if(!val || !activeChatId) return;
            input.value = "";
            const mRef = collection(db, "chats", activeChatId, "messages");
            await addDoc(mRef, { sender: currentUser.username, content: val, timestamp: serverTimestamp() });
            await updateDoc(doc(db, "chats", activeChatId), { lastMessage: val, lastTimestamp: serverTimestamp() });
        };

        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSend(); });
    </script>
</body>

</html>
